<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pixel World Cup ‚Äî 10 000 cases</title>
  <style>
    :root{ --cell:14px; --gap:1px; }
    html,body{ height:100% }
    body{
      margin:0; color:#fff; font-family:Inter,system-ui,Arial,sans-serif;
      background:
        radial-gradient(1400px 700px at 20% -10%, #3a2df0 0%, transparent 50%),
        radial-gradient(1200px 600px at 90% 0%, transparent 45%),
        #0b0c15;
      display:flex; flex-direction:column;
    }
    a{color:#7bd3ff; text-decoration:none} a:hover{text-decoration:underline}

    header{padding:18px 20px;background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-bottom:1px solid rgba(255,255,255,.08);}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#00ffd0,#ffe171);box-shadow:0 6px 18px rgba(0,0,0,.35);}
    .brand h1{margin:0;line-height:1;font-size:clamp(22px,3.6vw,36px);
      background:linear-gradient(90deg,#00ffd0,#ffe08a);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:13px;color:#dbe6ff;}
    .countdown{color:#ffe08a;font-weight:700}

    .toolbar{display:flex;gap:10px;align-items:center;padding:12px 0 4px;flex-wrap:wrap;}
    .btn{background:#171a2b;border:1px solid #2b2f4f;color:#eaf1ff;padding:9px 12px;border-radius:10px;font-size:14px;cursor:pointer;}
    .btn.primary{background:linear-gradient(180deg,#6fd1ff,#3a86ff);color:#061026;border-color:#2b6ad7;font-weight:700;box-shadow:0 8px 24px rgba(58,134,255,.35);}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .range{accent-color:#79f}

    #stage{flex:1;padding:18px;}
    #gridWrap{
      margin:auto;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px;
      box-shadow:0 12px 60px rgba(0,0,0,.35);
      width:max(720px,92vw);height:clamp(440px,70vh,78vh);
      overflow:auto;position:relative;
    }
    #grid{
      display:grid;grid-template-columns:repeat(100,var(--cell));grid-auto-rows:var(--cell);gap:var(--gap);
      background:#151934;
      width:calc(100*var(--cell) + 99*var(--gap));
      height:calc(100*var(--cell) + 99*var(--gap));
      position:relative; z-index:1;
    }
    .cell{width:var(--cell);height:var(--cell);background:#2b2f55;border:1px solid #3b3f68;box-sizing:border-box;cursor:pointer;transition:background .12s;}
    .cell:hover{background:#3b3f68}
    .sel{outline:1px solid #bcd1ff;}

    #selectionBox{
      position:absolute;pointer-events:none;border:2px dashed #7fb3ff;
      background:rgba(127,179,255,.15);display:none;z-index:5;
    }

    footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.08);text-align:center;color:#bcd1ff;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);}

    .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:10}
    .modal{width:min(560px,92vw);background:#0f1224;border:1px solid #2a2e52;border-radius:14px;padding:16px 16px 10px;box-shadow:0 30px 100px rgba(0,0,0,.6);}
    .modal h3{margin:0 0 10px}
    .row{display:flex;gap:10px;margin:8px 0;flex-wrap:wrap}
    .row label{width:140px;color:#d0d8ff;font-size:14px}
    .row input,.row textarea{flex:1;background:#171a35;border:1px solid #2b2f66;border-radius:8px;color:#eef;padding:8px 10px;font-size:14px;}
    .modal .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .priceTag{font-weight:800;color:#9effb6}
    .muted{color:#9aa;font-size:13px;white-space:pre-wrap}
    #errors{position:fixed;right:10px;bottom:10px;max-width:60ch;background:#2a1033;border:1px solid #723b87;border-radius:8px;padding:10px;display:none;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><h1>Pixel World Cup</h1></div>
      <div class="stats">
        <span class="pill">Total : <b>10 000</b></span>
        <span class="pill">Vendues : <b id="soldCount">0</b></span>
        <span class="pill">Disponibles : <b id="freeCount">10 000</b></span>
        <span class="pill countdown">Fin : <b id="countdown">‚Äî</b></span>
        <a class="pill" href="./about.html">Comment √ßa marche ?</a>
      </div>
    </div>
    <div class="toolbar">
      <button id="buyBtn" class="btn primary" disabled>Acheter mes cases</button>
      <button id="clearSelBtn" class="btn">D√©s√©lectionner</button>
      <label>Zoom <input id="zoom" class="range" type="range" min="10" max="24" step="1" value="14"/></label>
    </div>
  </header>

  <div id="stage">
    <div id="gridWrap">
      <div id="grid"></div>
      <div id="selectionBox"></div>
    </div>
  </div>

  <footer>¬©Ô∏è 2025 Pixel World Cup ‚Äî D√©mo locale.</footer>

  <!-- Modal -->
  <div id="modalWrap" class="modalWrap">
    <div class="modal">
      <h3>Finaliser l‚Äôachat</h3>
      <div class="row"><label>Votre nom</label><input id="mName" placeholder="Nom affich√© publiquement"/></div>
      <div class="row"><label>Email</label><input id="mEmail" type="email" placeholder="ton.email@example.com"/></div>
      <!-- ‚úÖ URL corrig√© -->
      <div class="row"><label>URL</label><input id="mLink" placeholder="[https://"/></div]https://"/></div>
      <div class="row"><label>Couleur</label><input id="mColor" type="color" value="#1e90ff"/></div>
      <div class="row"><label>Logo</label><input id="mLogo" placeholder="https://‚Ä¶/logo.png"/></div>
      <div class="row"><label>Message</label><textarea id="mMsg" rows="2"></textarea></div>
      <div class="muted">
        Cases s√©lectionn√©es : <b id="selCount">0</b> ‚Äî Total indicatif : <span class="priceTag" id="totalPrice">0 ‚Ç¨</span>
      </div>
      <div class="actions">
        <button id="cancelBuy" class="btn">Annuler</button>
        <button id="confirmStripe" class="btn primary">Confirmer & Payer</button>
      </div>
    </div>
  </div>

  <div id="errors"></div>

  <script>
  (function(){
    const box = document.getElementById('errors');
    window.addEventListener('error', (e)=>{
      box.style.display='block'; box.textContent = 'Erreur : ' + (e.error?.message || e.message || e.filename);
    });
    window.addEventListener('unhandledrejection', (e)=>{
      box.style.display='block'; box.textContent = 'Promise rejet√©e : ' + (e.reason?.message || e.reason || '');
    });
  })();

  document.addEventListener("DOMContentLoaded", () => {
    const UI_CELL_PRICE_EUR = 100;   // üí∞ 100 ‚Ç¨ la case (affichage)
    const COLS = 100, ROWS = 100, TOTAL = COLS * ROWS;
    const DEADLINE = new Date('2025-12-31T23:59:59+01:00');

    const grid = document.getElementById('grid'),
          gridWrap = document.getElementById('gridWrap'),
          box = document.getElementById('selectionBox'),
          buyBtn = document.getElementById('buyBtn'),
          clearBtn = document.getElementById('clearSelBtn'),
          soldEl = document.getElementById('soldCount'),
          freeEl = document.getElementById('freeCount'),
          countdownEl = document.getElementById('countdown'),
          modalWrap = document.getElementById('modalWrap'),
          mEmail = document.getElementById('mEmail'),
          selCountEl = document.getElementById('selCount'),
          totalPriceEl = document.getElementById('totalPrice');

    const selection = new Set();
    const cells = {};

    const fmtEUR = c => (Number(c||0)).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
    const step = () => {
      const cell = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'))||14;
      const gap  = parseInt(getComputedStyle(grid).gap)||1;
      return cell + gap;
    };
    const idAtClientPoint = (clientX, clientY) => {
      const rect = grid.getBoundingClientRect();
      const s = step();
      const x = Math.floor((clientX - rect.left) / s);
      const y = Math.floor((clientY - rect.top)  / s);
      if (x<0 || y<0 || x>=COLS || y>=ROWS) return null;
      return `${x}:${y}`;
    };

    (function buildGrid(){
      const frag = document.createDocumentFragment();
      for(let y=0;y<ROWS;y++){
        for(let x=0;x<COLS;x++){
          const d=document.createElement('div');
          d.className='cell';
          d.dataset.x=x; d.dataset.y=y;
          frag.appendChild(d);
        }
      }
      grid.appendChild(frag);
    })();

    grid.addEventListener('click', (e)=>{
      const cell = e.target.closest('.cell');
      if(!cell) return;
      const id = `${cell.dataset.x}:${cell.dataset.y}`;

      if (e.altKey) {
        selection.clear();
        grid.querySelectorAll('.cell.sel').forEach(n=>n.classList.remove('sel'));
      }

      if (selection.has(id)) {
        selection.delete(id);
        cell.classList.remove('sel');
      } else {
        selection.add(id);
        cell.classList.add('sel');
      }
      updateUI();
    });

    let dragging = false, startId = null;
    gridWrap.addEventListener('mousedown',(e)=>{
      const id = idAtClientPoint(e.clientX, e.clientY);
      if (!id) return;
      dragging = true; startId = id;

      if (e.altKey) {
        selection.clear();
        grid.querySelectorAll('.cell.sel').forEach(n=>n.classList.remove('sel'));
      }

      const s = step();
      const [sx, sy] = startId.split(':').map(Number);
      box.style.display='block';
      box.style.left  = (sx * s) + 'px';
      box.style.top   = (sy * s) + 'px';
      box.style.width = s + 'px';
      box.style.height= s + 'px';
      e.preventDefault();
    });

    window.addEventListener('mousemove',(e)=>{
      if(!dragging) return;
      const curId = idAtClientPoint(e.clientX, e.clientY);
      if(!curId) return;

      const s = step();
      const [sx, sy] = startId.split(':').map(Number);
      const [cx, cy] = curId.split(':').map(Number);
      const x1 = Math.min(sx, cx), x2 = Math.max(sx, cx);
      const y1 = Math.min(sy, cy), y2 = Math.max(sy, cy);

      box.style.display='block';
      box.style.left   = (x1 * s) + 'px';
      box.style.top    = (y1 * s) + 'px';
      box.style.width  = ((x2 - x1 + 1) * s - (parseInt(getComputedStyle(grid).gap)||1)) + 'px';
      box.style.height = ((y2 - y1 + 1) * s - (parseInt(getComputedStyle(grid).gap)||1)) + 'px';

      for(let y=y1;y<=y2;y++){
        for(let x=x1;x<=x2;x++){
          const id = `${x}:${y}`;
          if(!selection.has(id)){
            selection.add(id);
            const node = grid.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (node) node.classList.add('sel');
          }
        }
      }
      updateUI();
    });

    window.addEventListener('mouseup',()=>{
      if(!dragging) return;
      dragging=false; startId=null;
      box.style.display='none';
    });

    function updateUI(){
      const sold = Object.keys(cells).length;
      soldEl.textContent = sold.toLocaleString('fr-FR');
      freeEl.textContent = (TOTAL - sold).toLocaleString('fr-FR');

      const qty = selection.size;
      selCountEl.textContent = qty;
      totalPriceEl.textContent = fmtEUR(qty * UI_CELL_PRICE_EUR);
      buyBtn.disabled = qty === 0 || new Date() >= DEADLINE;
    }
    updateUI();

    buyBtn.addEventListener('click', ()=>{
      if(selection.size===0) return;
      if(new Date()>=DEADLINE){ alert('Comp√©tition termin√©e.'); return; }
      modalWrap.style.display='flex';
    });
    document.getElementById('cancelBuy').addEventListener('click', ()=> modalWrap.style.display='none');

    (function tick(){
      const ms = DEADLINE - new Date();
      if(ms<=0){ countdownEl.textContent='Termin√©'; buyBtn.disabled=true; return; }
      const s=Math.floor(ms/1000), d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
      countdownEl.textContent = `${d}j ${h}h ${m}m ${sec}s`;
      setTimeout(tick, 1000);
    })();

    clearBtn.addEventListener('click', ()=>{
      selection.clear();
      grid.querySelectorAll('.cell.sel').forEach(n=>n.classList.remove('sel'));
      updateUI();
    });

    // üîÅ ici : on utilise toujours le m√™me domaine que la page
    const API_BASE = window.location.origin;

    async function postJSON(url, body){
      const r = await fetch(url, {
        method:'POST',
        headers:{'content-type':'application/json'},
        body:JSON.stringify(body)
      });
      const data = await r.json().catch(()=> ({}));
      return { ok:r.ok, data };
    }

    (function attachConfirmHandler(){
      const btn = document.getElementById('confirmStripe');
      if (!btn){ console.error('‚ö†Ô∏è #confirmStripe introuvable'); return; }
      btn.addEventListener('click', onConfirmStripe);
      console.log('‚úÖ Handler confirmStripe attach√©.');
    })();

    async function onConfirmStripe(){
      try{
        if(selection.size===0){ alert('S√©lectionne des cases.'); return; }
        const buyerEmail = (mEmail.value||'').trim();
        if(!buyerEmail){ alert('Mets ton email.'); return; }

        // on transforme en 1 rectangle
        let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        for(const id of selection){
          const [x,y]=id.split(':').map(Number);
          minX=Math.min(minX,x); minY=Math.min(minY,y);
          maxX=Math.max(maxX,x); maxY=Math.max(maxY,y);
        }
        const x=minX, y=minY, w=maxX-minX+1, h=maxY-minY+1;

        // 1) Demander le devis (quote)
        const quote = await postJSON(`${API_BASE}/api/purchase-rect/quote`, body);
if (!quote.ok) {
  console.error(quote.data);
  alert('Erreur devis (quote_error)');
  return;
}
        // 2) Cr√©er la session Stripe
        const r = await postJSON(`${API_BASE}/api/purchase-rect/checkout`, { x,y,w,h,buyerEmail });
        if(!r.ok || !r.data?.ok){
          console.error(r.data);
          alert(r.data?.error || 'Erreur paiement');
          return;
        }

        // 3) redirection
        window.location.href = r.data.url;
      } catch(e){
        console.error(e);
        alert('Erreur : ' + (e.message||e));
      }
    }

  });
  </script>
</body>
</html>
