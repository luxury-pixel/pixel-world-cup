<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pixel World Cup — 10 000 cases</title>
  <style>
    :root{ --cell:14px; --gap:1px; }
    html,body{ height:100% }
    body{ margin:0; color:#fff; font-family:system-ui,Arial,sans-serif; background:#0b0c15; display:flex; flex-direction:column; }
    header{padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.08)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:13px}
    .btn{background:#171a2b;border:1px solid #2b2f4f;color:#eaf1ff;padding:9px 12px;border-radius:10px;font-size:14px;cursor:pointer;}
    .btn.primary{background:linear-gradient(180deg,#6fd1ff,#3a86ff);color:#061026;border-color:#2b6ad7;font-weight:700}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    #stage{flex:1;padding:18px}
    #gridWrap{margin:auto;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px; width:max(720px,92vw);height:clamp(440px,70vh,78vh); overflow:auto;position:relative;}
    #grid{ display:grid;grid-template-columns:repeat(100,var(--cell));grid-auto-rows:var(--cell);gap:var(--gap); background:#151934;
           width:calc(100*var(--cell) + 99*var(--gap)); height:calc(100*var(--cell) + 99*var(--gap)); position:relative; }
    .cell{width:var(--cell);height:var(--cell);background:#2b2f55;border:1px solid #3b3f68;box-sizing:border-box;cursor:pointer}
    .cell.sel{outline:1px solid #bcd1ff}
    .cell.sold{background:#253050;border-color:#3d4a6b; cursor:pointer}
    .cell.sold:hover{filter:brightness(1.08)}
    .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:10}
    .modal{width:min(560px,92vw);background:#0f1224;border:1px solid #2a2e52;border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;margin:8px 0;flex-wrap:wrap}
    .row label{width:140px;font-size:14px;color:#cfe}
    .row input,.row textarea{flex:1;background:#171a35;border:1px solid #2b2f66;border-radius:8px;color:#eef;padding:8px 10px}
    .muted{color:#9aa;font-size:13px}
    footer{padding:10px 16px;border-top:1px solid rgba(255,255,255,.08);text-align:center;color:#bcd1ff}
    #errors{position:fixed;right:10px;bottom:10px;max-width:60ch;background:#2a1033;border:1px solid #723b87;border-radius:8px;padding:10px;display:none;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#00ffd0,#ffe171)"></div>
        <h2 style="margin:0">Pixel World Cup</h2>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <span class="pill">Total: <b>10 000</b></span>
        <span class="pill">Vendues: <b id="soldCount">0</b></span>
        <span class="pill">Disponibles: <b id="freeCount">10 000</b></span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="buyBtn" class="btn primary" disabled>Acheter mes cases</button>
        <button id="clearSelBtn" class="btn">Désélectionner</button>
        <label>Zoom <input id="zoom" type="range" min="10" max="24" value="14"/></label>
      </div>
    </div>
  </header>

  <div id="stage">
    <div id="gridWrap">
      <div id="grid"></div>
    </div>
  </div>

  <footer>© 2025 Pixel World Cup</footer>

  <!-- Modal -->
  <div id="modalWrap" class="modalWrap">
    <div class="modal">
      <h3>Finaliser l’achat</h3>
      <div class="row"><label>Votre nom</label><input id="mName" placeholder="Nom public"/></div>
      <div class="row"><label>Email</label><input id="mEmail" type="email" placeholder="ton.email@example.com"/></div>
      <div class="row"><label>URL</label><input id="mLink" placeholder="[https://votre-site.com"/></div]https://votre-site.com"/></div>
      <div class="row"><label>Couleur</label><input id="mColor" type="color" value="#1e90ff"/></div>
      <div class="row"><label>Logo</label><input id="mLogo" placeholder="https://…/logo.png"/></div>
      <div class="row"><label>Message</label><textarea id="mMsg" rows="2"></textarea></div>
      <div class="muted">Cases sélectionnées : <b id="selCount">0</b> — Total indicatif : <b id="totalPrice">0 €</b></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="cancelBuy" class="btn">Annuler</button>
        <button id="confirmStripe" class="btn primary">Confirmer & Payer</button>
      </div>
    </div>
  </div>

  <div id="errors"></div>

  <script>
  // petit catcher d'erreurs
  (function(){
    const box = document.getElementById('errors');
    window.addEventListener('error', (e)=>{ box.style.display='block'; box.textContent='Erreur: '+(e.error?.message||e.message) });
    window.addEventListener('unhandledrejection', (e)=>{ box.style.display='block'; box.textContent='Rejet: '+(e.reason?.message||e.reason) });
  })();

  document.addEventListener('DOMContentLoaded', () => {
    const UI_CELL_PRICE_EUR = 100;
    const COLS = 100, ROWS = 100, TOTAL = COLS*ROWS;

    const grid = document.getElementById('grid');
    const gridWrap = document.getElementById('gridWrap');
    const buyBtn = document.getElementById('buyBtn');
    const clearBtn = document.getElementById('clearSelBtn');
    const soldEl = document.getElementById('soldCount');
    const freeEl = document.getElementById('freeCount');
    const selCountEl = document.getElementById('selCount');
    const totalPriceEl = document.getElementById('totalPrice');

    const modalWrap = document.getElementById('modalWrap');
    const mName = document.getElementById('mName');
    const mEmail = document.getElementById('mEmail');
    const mLink = document.getElementById('mLink');
    const mLogo = document.getElementById('mLogo');
    const mColor = document.getElementById('mColor');
    const mMsg = document.getElementById('mMsg');

    const selection = new Set();
    const cells = {}; // clé -> {sold, link, logo, color}

    const API_BASE = window.location.origin;

    function step(){
      const cs = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'))||14;
      const gap =  parseInt(getComputedStyle(grid).gap)||1;
      return cs + gap;
    }

    function buildGrid(){
      const frag = document.createDocumentFragment();
      for(let y=0;y<ROWS;y++){
        for(let x=0;x<COLS;x++){
          const d=document.createElement('div');
          d.className='cell';
          d.dataset.x=x; d.dataset.y=y;
          frag.appendChild(d);
        }
      }
      grid.appendChild(frag);
    }

    function markSoldFromDB(db){
      Object.keys(db.cells||{}).forEach(key=>{
        const h = db.cells[key];
        if(!h || h.length===0) return;
        const last = h[h.length-1];
        const el = grid.querySelector(`.cell[data-x="${key.split(':')[0]}"][data-y="${key.split(':')[1]}"]`);
        if(!el) return;
        el.classList.add('sold');
        el.style.backgroundImage = last.logo ? `url("${last.logo}")` : '';
        el.style.backgroundSize = 'cover';
        el.style.backgroundPosition = 'center';
        cells[key] = { sold:true, link:last.link||null, logo:last.logo||null, color:last.color||null };
      });
      const sold = Object.keys(cells).length;
      soldEl.textContent = sold.toLocaleString('fr-FR');
      freeEl.textContent = (TOTAL - sold).toLocaleString('fr-FR');
    }

    async function loadDBAndPaint(){
      try{
        const r = await fetch('/data/db.json', { cache:'no-store' });
        const db = await r.json();
        markSoldFromDB(db);
      }catch(e){ console.warn('no db yet'); }
    }

    function updateUI(){
      const qty = selection.size;
      selCountEl.textContent = qty;
      // devis live côté serveur (affiche bien le double si recouvrement)
      (async ()=>{
        if(qty===0){ totalPriceEl.textContent = (0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); buyBtn.disabled=true; return; }
        let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        for(const id of selection){
          const [x,y]=id.split(':').map(Number);
          minX=Math.min(minX,x); minY=Math.min(minY,y);
          maxX=Math.max(maxX,x); maxY=Math.max(maxY,y);
        }
        const body = { x:minX, y:minY, w:maxX-minX+1, h:maxY-minY+1, buyerEmail: (mEmail.value||'demo@test.com') };
        const q = await postJSON(`${API_BASE}/api/purchase-rect/quote`, body);
        if(q.ok && q.data){
          totalPriceEl.textContent = (q.data.totalCents/100).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
          buyBtn.disabled = false;
        }else{
          buyBtn.disabled = true;
        }
      })();
    }

    function toggleSelect(el){
      const id = `${el.dataset.x}:${el.dataset.y}`;
      if(el.classList.contains('sold')){
        // clic sur case vendue -> si lien dispo, on ouvre
        const info = cells[id];
        if(info?.link) window.open(info.link, '_blank');
        return;
      }
      if(selection.has(id)){ selection.delete(id); el.classList.remove('sel'); }
      else { selection.add(id); el.classList.add('sel'); }
      updateUI();
    }

    grid.addEventListener('click',(e)=>{
      const cell = e.target.closest('.cell');
      if(!cell) return;
      toggleSelect(cell);
    });

    clearBtn.addEventListener('click', ()=>{
      selection.clear();
      grid.querySelectorAll('.cell.sel').forEach(n=>n.classList.remove('sel'));
      updateUI();
    });

    document.getElementById('zoom').addEventListener('input', (e)=>{
      document.documentElement.style.setProperty('--cell', e.target.value+'px');
    });

    function postJSON(url, body){
      return fetch(url,{
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(body)
      }).then(r=>r.json().then(d=>({ok:r.ok,data:d})).catch(()=>({ok:r.ok,data:{}})));
    }

    // bouton Acheter
    document.getElementById('buyBtn').addEventListener('click', ()=>{
      if(selection.size===0) return;
      modalWrap.style.display='flex';
    });
    document.getElementById('cancelBuy').addEventListener('click', ()=> modalWrap.style.display='none');

    document.getElementById('confirmStripe').addEventListener('click', onConfirmStripe);

    async function onConfirmStripe(){
      try{
        if(selection.size===0){ alert('Sélectionne des cases.'); return; }
        const buyerEmail = (mEmail.value||'').trim();
        if(!buyerEmail){ alert('Mets ton email.'); return; }

        // rectangle englobant
        let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
        for(const id of selection){
          const [x,y]=id.split(':').map(Number);
          minX=Math.min(minX,x); minY=Math.min(minY,y);
          maxX=Math.max(maxX,x); maxY=Math.max(maxY,y);
        }
        const x=minX, y=minY, w=maxX-minX+1, h=maxY-minY+1;

        // checkout (on envoie aussi meta pour le webhook)
        const r = await postJSON(`${API_BASE}/api/purchase-rect/checkout`, {
          x,y,w,h,
          buyerEmail,
          name: (mName.value||'').trim(),
          link: (mLink.value||'').trim(),
          logo: (mLogo.value||'').trim(),
          color: (mColor.value||'').trim(),
          message: (mMsg.value||'').trim()
        });
        if(!r.ok || !r.data?.url){
          alert(r.data?.error || 'Erreur paiement');
          return;
        }

        // clear sélection avant la redirection
        selection.clear();
        grid.querySelectorAll('.cell.sel').forEach(n=>n.classList.remove('sel'));

        window.location.href = r.data.url;
      }catch(e){
        console.error(e);
        alert('Erreur : '+(e.message||e));
      }
    }

    // go
    buildGrid();
    loadDBAndPaint();
    updateUI();
  });
  </script>
</body>
</html>

